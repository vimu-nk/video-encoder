<!DOCTYPE html>
<html>
	<head>
		<title>Encoding Status</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 40px;
			}
			.job {
				margin: 20px 0;
				padding: 15px;
				border: 1px solid #ddd;
				border-radius: 5px;
				transition: all 0.3s ease;
			}
			.status-idle {
				background-color: #f9f9f9;
			}
			.status-downloading {
				background-color: #e3f2fd;
			}
			.status-encoding {
				background-color: #fff3e0;
			}
			.status-uploading {
				background-color: #f3e5f5;
			}
			.status-completed {
				background-color: #e8f5e8;
			}
			.status-failed {
				background-color: #ffebee;
			}
			.log {
				background: #f5f5f5;
				padding: 10px;
				margin: 10px 0;
				font-family: monospace;
				white-space: pre-wrap;
				max-height: 200px;
				overflow-y: auto;
			}
			.progress {
				width: 100%;
				background-color: #f0f0f0;
				border-radius: 3px;
				overflow: hidden;
				margin: 10px 0;
			}
			.progress-bar {
				height: 20px;
				background-color: #4caf50;
				transition: width 0.3s ease;
			}
			.controls {
				margin: 20px 0;
				padding: 15px;
				background: #f8f9fa;
				border-radius: 5px;
			}
			.auto-refresh {
				margin: 10px 0;
			}
			.auto-refresh label {
				margin-left: 5px;
			}
			.refresh-status {
				color: #666;
				font-size: 0.9em;
				margin: 5px 0;
			}
			button {
				background: #007cba;
				color: white;
				padding: 10px 20px;
				border: none;
				cursor: pointer;
				text-decoration: none;
				display: inline-block;
				border-radius: 3px;
				margin: 5px;
			}
			button:hover {
				background: #005a87;
			}
			.last-updated {
				color: #666;
				font-size: 0.8em;
				text-align: right;
				margin: 10px 0;
			}
		</style>
	</head>
	<body>
		<h1>Job Status</h1>

		<div class="controls">
			<div class="auto-refresh">
				<input type="checkbox" id="autoRefresh" checked />
				<label for="autoRefresh">Auto-refresh every 3 seconds</label>
			</div>
			<button onclick="refreshStatus()">Refresh Now</button>
			<div class="refresh-status" id="refreshStatus">
				Auto-refresh enabled
			</div>
			<div class="last-updated" id="lastUpdated">Last updated: Never</div>
		</div>

		<div id="jobContainer">
			{% if status %} {% for filename, job in status.items() %}
			<div class="job status-{{ job.status }}" id="job-{{ loop.index }}">
				<h3>{{ filename }}</h3>
				<p>
					<strong>Status:</strong>
					<span class="job-status">{{ job.status|title }}</span>
				</p>

				{% if job.percent %}
				<div class="progress">
					<div
						class="progress-bar"
						style="width: {{ job.percent }}%"
					></div>
				</div>
				<p>
					Progress:
					<span class="job-progress">{{ job.percent }}</span>%
				</p>
				{% endif %} {% if job.log %}
				<div class="log job-log">{{ job.log }}</div>
				{% endif %}
			</div>
			{% endfor %} {% else %}
			<p>No encoding jobs found.</p>
			{% endif %}
		</div>

		<br />
		<a
			href="/"
			style="
				background: #007cba;
				color: white;
				padding: 10px 20px;
				text-decoration: none;
				border-radius: 3px;
			"
			>Back to Dashboard</a
		>

		<script>
			let autoRefreshInterval = null;
			let isRefreshing = false;

			// Auto-refresh functionality
			function startAutoRefresh() {
				if (autoRefreshInterval) {
					clearInterval(autoRefreshInterval);
				}

				autoRefreshInterval = setInterval(async () => {
					if (
						document.getElementById("autoRefresh").checked &&
						!isRefreshing
					) {
						await refreshStatus();
					}
				}, 3000); // 3 seconds
			}

			// Manual refresh
			async function refreshStatus() {
				if (isRefreshing) return;

				isRefreshing = true;
				const refreshStatusEl =
					document.getElementById("refreshStatus");
				refreshStatusEl.textContent = "Refreshing...";

				try {
					const response = await fetch("/api/status");
					const data = await response.json();
					updateJobStatus(data);

					// Update last updated time
					const now = new Date();
					document.getElementById(
						"lastUpdated"
					).textContent = `Last updated: ${now.toLocaleTimeString()}`;

					refreshStatusEl.textContent = "Auto-refresh enabled";
				} catch (error) {
					console.error("Failed to refresh status:", error);
					refreshStatusEl.textContent =
						"Refresh failed - retrying...";
				} finally {
					isRefreshing = false;
				}
			}

			// Update job status in the DOM
			function updateJobStatus(statusData) {
				const container = document.getElementById("jobContainer");

				if (Object.keys(statusData).length === 0) {
					container.innerHTML = "<p>No encoding jobs found.</p>";
					return;
				}

				let html = "";
				let jobIndex = 1;

				for (const [filename, job] of Object.entries(statusData)) {
					html += `
						<div class="job status-${job.status}" id="job-${jobIndex}">
							<h3>${filename}</h3>
							<p><strong>Status:</strong> <span class="job-status">${
								job.status.charAt(0).toUpperCase() +
								job.status.slice(1)
							}</span></p>
							
							${
								job.percent
									? `
							<div class="progress">
								<div class="progress-bar" style="width: ${job.percent}%"></div>
							</div>
							<p>Progress: <span class="job-progress">${job.percent}</span>%</p>
							`
									: ""
							}
							
							${
								job.log
									? `
							<div class="log job-log">${job.log}</div>
							`
									: ""
							}
						</div>
					`;
					jobIndex++;
				}

				container.innerHTML = html;
			}

			// Auto-refresh toggle
			document
				.getElementById("autoRefresh")
				.addEventListener("change", function () {
					const refreshStatusEl =
						document.getElementById("refreshStatus");
					if (this.checked) {
						startAutoRefresh();
						refreshStatusEl.textContent = "Auto-refresh enabled";
					} else {
						if (autoRefreshInterval) {
							clearInterval(autoRefreshInterval);
						}
						refreshStatusEl.textContent = "Auto-refresh disabled";
					}
				});

			// Start auto-refresh on page load
			document.addEventListener("DOMContentLoaded", function () {
				startAutoRefresh();
				// Initial refresh
				refreshStatus();
			});

			// Clean up interval when page is unloaded
			window.addEventListener("beforeunload", function () {
				if (autoRefreshInterval) {
					clearInterval(autoRefreshInterval);
				}
			});
		</script>
	</body>
</html>

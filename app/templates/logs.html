<!DOCTYPE html>
<html>
	<head>
		<title>Video Encoder - Job Logs</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 40px;
				background-color: #f5f5f5;
			}
			.header {
				background: white;
				padding: 20px;
				border-radius: 8px;
				margin-bottom: 20px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.stats-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
				gap: 15px;
				margin: 20px 0;
			}
			.stat-card {
				background: #fff;
				padding: 15px;
				border-radius: 6px;
				text-align: center;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.stat-number {
				font-size: 24px;
				font-weight: bold;
				margin-bottom: 5px;
			}
			.stat-label {
				color: #666;
				font-size: 12px;
			}
			.queued {
				color: #ff9800;
			}
			.running {
				color: #2196f3;
			}
			.completed {
				color: #4caf50;
			}
			.failed {
				color: #f44336;
			}

			.jobs-container {
				background: white;
				border-radius: 8px;
				overflow: hidden;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.job-item {
				border-bottom: 1px solid #eee;
				padding: 15px 20px;
				transition: background-color 0.2s;
			}
			.job-item:hover {
				background-color: #f9f9f9;
			}
			.job-item:last-child {
				border-bottom: none;
			}
			.job-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 8px;
			}
			.job-filename {
				font-weight: bold;
				color: #333;
			}
			.job-status {
				padding: 4px 8px;
				border-radius: 12px;
				font-size: 12px;
				font-weight: bold;
				text-transform: uppercase;
			}
			.status-queued {
				background: #fff3e0;
				color: #ff9800;
			}
			.status-downloading {
				background: #e3f2fd;
				color: #2196f3;
			}
			.status-encoding {
				background: #e3f2fd;
				color: #2196f3;
			}
			.status-uploading {
				background: #e3f2fd;
				color: #2196f3;
			}
			.status-completed {
				background: #e8f5e8;
				color: #4caf50;
			}
			.status-failed {
				background: #ffebee;
				color: #f44336;
			}

			.job-details {
				font-size: 14px;
				color: #666;
				margin-bottom: 8px;
			}
			.progress-bar {
				width: 100%;
				height: 6px;
				background: #eee;
				border-radius: 3px;
				overflow: hidden;
				margin: 8px 0;
			}
			.progress-fill {
				height: 100%;
				background: #2196f3;
				transition: width 0.3s ease;
			}
			.job-log {
				background: #f5f5f5;
				border: 1px solid #ddd;
				border-radius: 4px;
				padding: 10px;
				font-family: monospace;
				font-size: 12px;
				max-height: 200px;
				overflow-y: auto;
				white-space: pre-wrap;
				margin-top: 10px;
			}
			.job-error {
				background: #ffebee;
				border: 1px solid #f44336;
				color: #d32f2f;
				padding: 10px;
				border-radius: 4px;
				margin-top: 10px;
				font-family: monospace;
				font-size: 12px;
			}
			.loading {
				text-align: center;
				padding: 40px;
				color: #666;
			}
			.nav-links {
				margin: 20px 0;
			}
			.nav-links a {
				color: #007cba;
				text-decoration: none;
				margin-right: 20px;
				padding: 8px 16px;
				background: white;
				border-radius: 4px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.nav-links a:hover {
				text-decoration: underline;
			}
			.refresh-btn {
				background: #2196f3;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
			}
			.refresh-btn:hover {
				background: #1976d2;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>Video Encoder - Job Queue & Logs</h1>

			<div class="nav-links">
				<a href="/">‚Üê Back to Dashboard</a>
				<button class="refresh-btn" onclick="loadQueueData()">
					üîÑ Refresh
				</button>
			</div>

			<div class="stats-grid" id="statsGrid">
				<div class="stat-card">
					<div class="stat-number" id="totalJobs">-</div>
					<div class="stat-label">Total Jobs</div>
				</div>
				<div class="stat-card">
					<div class="stat-number queued" id="queuedJobs">-</div>
					<div class="stat-label">Queued</div>
				</div>
				<div class="stat-card">
					<div class="stat-number running" id="runningJobs">-</div>
					<div class="stat-label">Running</div>
				</div>
				<div class="stat-card">
					<div class="stat-number completed" id="completedJobs">
						-
					</div>
					<div class="stat-label">Completed</div>
				</div>
				<div class="stat-card">
					<div class="stat-number failed" id="failedJobs">-</div>
					<div class="stat-label">Failed</div>
				</div>
			</div>
		</div>

		<div class="jobs-container">
			<div id="jobsList" class="loading">Loading job queue...</div>
		</div>

		<script>
			function formatDate(dateString) {
				if (!dateString) return "-";
				const date = new Date(dateString);
				return date.toLocaleString();
			}

			function formatFilename(filePath) {
				return filePath.split("/").pop();
			}

			function getStatusClass(status) {
				return `status-${status}`;
			}

			function updateStats(stats) {
				document.getElementById("totalJobs").textContent =
					stats.total_jobs;
				document.getElementById("queuedJobs").textContent =
					stats.queued;
				document.getElementById("runningJobs").textContent =
					stats.running;
				document.getElementById("completedJobs").textContent =
					stats.completed;
				document.getElementById("failedJobs").textContent =
					stats.failed;
			}

			function renderJobs(jobs) {
				const jobsList = document.getElementById("jobsList");

				if (jobs.length === 0) {
					jobsList.innerHTML =
						'<div class="loading">No jobs found</div>';
					return;
				}

				// Sort jobs by creation time (newest first)
				jobs.sort(
					(a, b) => new Date(b.created_at) - new Date(a.created_at)
				);

				const jobsHtml = jobs
					.map((job) => {
						const filename = formatFilename(job.file_path);
						const statusClass = getStatusClass(job.status);

						return `
                    <div class="job-item">
                        <div class="job-header">
                            <div class="job-filename">${filename}</div>
                            <div class="job-status ${statusClass}">${
							job.status
						}</div>
                        </div>
                        
                        <div class="job-details">
                            <strong>Job ID:</strong> ${job.id} | 
                            <strong>Preset:</strong> ${job.preset} | 
                            <strong>Created:</strong> ${formatDate(
								job.created_at
							)}
                            ${
								job.started_at
									? ` | <strong>Started:</strong> ${formatDate(
											job.started_at
									  )}`
									: ""
							}
                            ${
								job.completed_at
									? ` | <strong>Completed:</strong> ${formatDate(
											job.completed_at
									  )}`
									: ""
							}
                        </div>
                        
                        ${
							job.progress > 0
								? `
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${job.progress}%"></div>
                            </div>
                            <div style="font-size: 12px; color: #666;">Progress: ${job.progress}%</div>
                        `
								: ""
						}
                        
                        ${
							job.error
								? `
                            <div class="job-error">
                                <strong>Error:</strong> ${job.error}
                            </div>
                        `
								: ""
						}
                        
                        ${
							job.log
								? `
                            <div class="job-log">${job.log}</div>
                        `
								: ""
						}
                    </div>
                `;
					})
					.join("");

				jobsList.innerHTML = jobsHtml;
			}

			async function loadQueueData() {
				try {
					const response = await fetch("/api/queue");
					const data = await response.json();

					updateStats(data.stats);
					renderJobs(data.jobs);
				} catch (error) {
					console.error("Error loading queue data:", error);
					document.getElementById("jobsList").innerHTML =
						'<div class="loading">Error loading job data. Please refresh the page.</div>';
				}
			}

			// Load initial data
			loadQueueData();

			// Auto-refresh every 5 seconds
			setInterval(loadQueueData, 5000);
		</script>
	</body>
</html>

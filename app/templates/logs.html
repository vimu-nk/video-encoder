<!DOCTYPE html>
<html>
	<head>
		<title>Video Encoder - Job Status</title>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<style>
			body {
				font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
				margin: 0;
				padding: 20px;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
			}
			.container {
				max-width: 1200px;
				margin: 0 auto;
				background: white;
				border-radius: 12px;
				box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
				overflow: hidden;
			}
			.header {
				background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
				color: white;
				padding: 30px;
				text-align: center;
				position: relative;
			}
			.header h1 {
				margin: 0;
				font-size: 2.5em;
				font-weight: 300;
			}
			.header p {
				margin: 10px 0 0 0;
				opacity: 0.8;
				font-size: 1.1em;
			}
			.auto-refresh {
				position: absolute;
				top: 20px;
				right: 20px;
				background: rgba(255, 255, 255, 0.2);
				color: white;
				padding: 8px 16px;
				border-radius: 20px;
				font-size: 12px;
				backdrop-filter: blur(10px);
			}
			.content {
				padding: 30px;
			}
			.status-card {
				background: #f8f9fa;
				border-radius: 8px;
				padding: 25px;
				margin-bottom: 25px;
				border-left: 5px solid #007bff;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
			}
			.status-badge {
				padding: 8px 16px;
				border-radius: 20px;
				font-weight: bold;
				text-transform: uppercase;
				font-size: 12px;
				display: inline-block;
				margin-bottom: 15px;
				letter-spacing: 1px;
			}
			.status-idle {
				background: #e9ecef;
				color: #6c757d;
			}
			.status-queued {
				background: #fff3cd;
				color: #856404;
			}
			.status-downloading {
				background: #cce5ff;
				color: #004085;
			}
			.status-encoding {
				background: #d1ecf1;
				color: #0c5460;
			}
			.status-uploading {
				background: #d4edda;
				color: #155724;
			}
			.status-completed {
				background: #d4edda;
				color: #155724;
			}
			.status-failed {
				background: #f8d7da;
				color: #721c24;
			}
			.job-info {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
				gap: 20px;
				margin-bottom: 25px;
			}
			.info-item {
				background: white;
				padding: 20px;
				border-radius: 8px;
				border: 1px solid #e9ecef;
			}
			.info-label {
				font-size: 12px;
				color: #6c757d;
				text-transform: uppercase;
				font-weight: 600;
				margin-bottom: 8px;
				letter-spacing: 1px;
			}
			.info-value {
				font-size: 16px;
				font-weight: 500;
				color: #2c3e50;
			}
			.progress-container {
				margin: 25px 0;
			}
			.progress-bar {
				width: 100%;
				height: 25px;
				background: #e9ecef;
				border-radius: 12px;
				overflow: hidden;
				position: relative;
				box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.progress-fill {
				height: 100%;
				background: linear-gradient(90deg, #007bff, #28a745);
				transition: width 0.5s ease;
				border-radius: 12px;
				position: relative;
			}
			.progress-fill::after {
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: linear-gradient(
					90deg,
					transparent,
					rgba(255, 255, 255, 0.3),
					transparent
				);
				animation: shimmer 2s infinite;
			}
			@keyframes shimmer {
				0% {
					transform: translateX(-100%);
				}
				100% {
					transform: translateX(100%);
				}
			}
			.progress-text {
				text-align: center;
				font-size: 14px;
				color: #495057;
				margin-top: 10px;
				font-weight: 500;
			}
			.log-container {
				background: #1e1e1e;
				color: #ffffff;
				border-radius: 8px;
				padding: 20px;
				font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
				font-size: 14px;
				max-height: 500px;
				overflow-y: auto;
				border: 1px solid #333;
				line-height: 1.5;
				white-space: pre-wrap;
				word-break: break-word;
			}
			.log-container::-webkit-scrollbar {
				width: 8px;
			}
			.log-container::-webkit-scrollbar-track {
				background: #2d2d2d;
			}
			.log-container::-webkit-scrollbar-thumb {
				background: #555;
				border-radius: 4px;
			}
			.compression-stats {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 15px;
				margin: 20px 0;
			}
			.stat-item {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 20px;
				border-radius: 8px;
				text-align: center;
			}
			.stat-value {
				font-size: 24px;
				font-weight: bold;
				margin-bottom: 5px;
			}
			.stat-label {
				font-size: 12px;
				opacity: 0.9;
				text-transform: uppercase;
				letter-spacing: 1px;
			}
			.actions {
				margin: 25px 0;
				text-align: center;
			}
			.btn {
				display: inline-block;
				padding: 12px 24px;
				background: #007bff;
				color: white;
				text-decoration: none;
				border-radius: 6px;
				font-weight: 500;
				margin: 0 10px;
				transition: all 0.3s ease;
				border: none;
				cursor: pointer;
				font-size: 14px;
			}
			.btn:hover {
				background: #0056b3;
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
			}
			.btn-secondary {
				background: #6c757d;
			}
			.btn-secondary:hover {
				background: #545b62;
			}
			.btn-danger {
				background: #dc3545;
			}
			.btn-danger:hover {
				background: #c82333;
			}
			.hardware-info {
				background: #f8f9fa;
				border-radius: 8px;
				padding: 20px;
				margin-bottom: 25px;
				border-left: 5px solid #28a745;
			}
			.hardware-info h3 {
				margin: 0 0 15px 0;
				color: #2c3e50;
				font-size: 18px;
			}
			.gpu-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 15px;
			}
			.gpu-item {
				background: white;
				padding: 15px;
				border-radius: 6px;
				border: 1px solid #e9ecef;
			}
			.error-message {
				background: #f8d7da;
				color: #721c24;
				padding: 15px;
				border-radius: 6px;
				border: 1px solid #f5c6cb;
				margin: 15px 0;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<div class="auto-refresh" id="autoRefresh">
					üîÑ Auto-refresh every 2s
				</div>
				<h1>Video Encoder Dashboard</h1>
				<p>Real-time encoding status and progress monitoring</p>
			</div>
			<div class="content">
				<div class="status-card" id="statusCard">
					<div class="status-badge" id="statusBadge">Loading...</div>
					<div class="job-info" id="jobInfo">
						<div class="info-item">
							<div class="info-label">Current File</div>
							<div class="info-value" id="currentFile">
								No active job
							</div>
						</div>
						<div class="info-item">
							<div class="info-label">Job Status</div>
							<div class="info-value" id="jobStatus">Idle</div>
						</div>
						<div class="info-item">
							<div class="info-label">Progress</div>
							<div class="info-value" id="progressValue">0%</div>
						</div>
						<div class="info-item">
							<div class="info-label">Last Updated</div>
							<div class="info-value" id="lastUpdated">-</div>
						</div>
					</div>
					<div
						class="progress-container"
						id="progressContainer"
						style="display: none"
					>
						<div class="progress-bar">
							<div
								class="progress-fill"
								id="progressFill"
								style="width: 0%"
							></div>
						</div>
						<div class="progress-text" id="progressText">
							0% complete
						</div>
					</div>
					<div
						class="compression-stats"
						id="compressionStats"
						style="display: none"
					>
						<div class="stat-item">
							<div class="stat-value" id="originalSize">-</div>
							<div class="stat-label">Original Size</div>
						</div>
						<div class="stat-item">
							<div class="stat-value" id="compressedSize">-</div>
							<div class="stat-label">Compressed Size</div>
						</div>
						<div class="stat-item">
							<div class="stat-value" id="compressionRatio">
								-
							</div>
							<div class="stat-label">Space Saved</div>
						</div>
						<div class="stat-item">
							<div class="stat-value" id="spaceSaved">-</div>
							<div class="stat-label">MB Saved</div>
						</div>
					</div>
					<div
						class="error-message"
						id="errorMessage"
						style="display: none"
					></div>
				</div>
				<div class="hardware-info" id="hardwareInfo">
					<h3>üñ•Ô∏è Hardware Information</h3>
					<div class="gpu-grid" id="gpuGrid">
						<div class="gpu-item">Loading hardware info...</div>
					</div>
				</div>
				<div class="status-card">
					<h3>üìã Process Log</h3>
					<div class="log-container" id="logContainer">
						Loading logs...
					</div>
				</div>
				<div class="actions">
					<a href="/" class="btn">üè† Back to Dashboard</a>
					<button class="btn btn-secondary" onclick="refreshStatus()">
						üîÑ Refresh Now
					</button>
					<button
						class="btn btn-danger"
						onclick="stopEncoding()"
						id="stopBtn"
						style="display: none"
					>
						‚èπÔ∏è Stop Encoding
					</button>
				</div>
			</div>
		</div>
		<script>
			let refreshInterval;
			let isRefreshing = false;
			function formatBytes(bytes) {
				if (bytes === 0) return "0 B";
				const k = 1024;
				const sizes = ["B", "KB", "MB", "GB"];
				const i = Math.floor(Math.log(bytes) / Math.log(k));
				return (
					parseFloat((bytes / Math.pow(k, i)).toFixed(2)) +
					" " +
					sizes[i]
				);
			}
			function formatTime(date) {
				return new Date(date).toLocaleTimeString();
			}
			function updateStatusUI(job) {
				const statusBadge = document.getElementById("statusBadge");
				const statusCard = document.getElementById("statusCard");
				const currentFile = document.getElementById("currentFile");
				const jobStatus = document.getElementById("jobStatus");
				const progressValue = document.getElementById("progressValue");
				const lastUpdated = document.getElementById("lastUpdated");
				const progressContainer =
					document.getElementById("progressContainer");
				const progressFill = document.getElementById("progressFill");
				const progressText = document.getElementById("progressText");
				const compressionStats =
					document.getElementById("compressionStats");
				const errorMessage = document.getElementById("errorMessage");
				const stopBtn = document.getElementById("stopBtn"); // Update status badge            statusBadge.textContent = job.status.toUpperCase();            statusBadge.className = `status-badge status-${job.status}`;

				// Update status card border
				const statusColors = {
					idle: "#6c757d",
					queued: "#ffc107",
					downloading: "#007bff",
					encoding: "#17a2b8",
					uploading: "#28a745",
					completed: "#28a745",
					failed: "#dc3545",
				};
				statusCard.style.borderLeftColor =
					statusColors[job.status] || "#007bff";

				// Update job info
				currentFile.textContent = job.filename || "No active job";
				jobStatus.textContent =
					job.status.charAt(0).toUpperCase() + job.status.slice(1);
				progressValue.textContent = `${job.progress || 0}%`;
				lastUpdated.textContent = formatTime(new Date());

				// Update progress bar
				if (job.progress > 0 && job.status !== "idle") {
					progressContainer.style.display = "block";
					progressFill.style.width = `${job.progress}%`;
					progressText.textContent = `${job.progress}% complete`;
				} else {
					progressContainer.style.display = "none";
				}

				// Update compression stats
				if (
					job.compression_stats &&
					job.compression_stats.compression_ratio > 0
				) {
					compressionStats.style.display = "grid";
					document.getElementById("originalSize").textContent =
						formatBytes(job.compression_stats.original_size);
					document.getElementById("compressedSize").textContent =
						formatBytes(job.compression_stats.compressed_size);
					document.getElementById(
						"compressionRatio"
					).textContent = `${job.compression_stats.compression_ratio}%`;
					document.getElementById(
						"spaceSaved"
					).textContent = `${job.compression_stats.space_saved_mb} MB`;
				} else {
					compressionStats.style.display = "none";
				}

				// Update error message
				if (job.error) {
					errorMessage.style.display = "block";
					errorMessage.textContent = `Error: ${job.error}`;
				} else {
					errorMessage.style.display = "none";
				}

				// Show/hide stop button
				if (
					["downloading", "encoding", "uploading"].includes(
						job.status
					)
				) {
					stopBtn.style.display = "inline-block";
				} else {
					stopBtn.style.display = "none";
				}

				// Update log
				const logContainer = document.getElementById("logContainer");
				logContainer.textContent = job.log || "No log data available";
				logContainer.scrollTop = logContainer.scrollHeight;
			}

			async function loadHardwareInfo() {
				try {
					const response = await fetch("/api/hardware");
					const data = await response.json();
					const gpuGrid = document.getElementById("gpuGrid");

					if (
						data.gpu_available &&
						data.gpus &&
						data.gpus.length > 0
					) {
						gpuGrid.innerHTML = data.gpus
							.map(
								(gpu) => `
                        <div class="gpu-item">
                            <div style="font-weight: bold; margin-bottom: 5px;">${gpu.name}</div>
                            <div style="font-size: 12px; color: #666;">
                                Memory: ${gpu.memory_total}<br>
                                Used: ${gpu.memory_used}<br>
                                Utilization: ${gpu.utilization}
                            </div>
                        </div>
                    `
							)
							.join("");
					} else {
						gpuGrid.innerHTML = `
                        <div class="gpu-item">
                            <div style="font-weight: bold; margin-bottom: 5px;">No GPU Detected</div>
                            <div style="font-size: 12px; color: #666;">
                                Using CPU encoding (x265)
                            </div>
                        </div>
                    `;
					}

					// Add NVENC capabilities
					if (data.nvenc_caps) {
						const nvencInfo = [];
						if (data.nvenc_caps.av1) nvencInfo.push("AV1 NVENC");
						if (data.nvenc_caps.hevc) nvencInfo.push("HEVC NVENC");
						if (data.nvenc_caps.h264) nvencInfo.push("H.264 NVENC");

						if (nvencInfo.length > 0) {
							gpuGrid.innerHTML += `
                            <div class="gpu-item">
                                <div style="font-weight: bold; margin-bottom: 5px;">NVENC Encoders</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${nvencInfo.join("<br>")}
                                </div>
                            </div>
                        `;
						}
					}
				} catch (error) {
					console.error("Failed to load hardware info:", error);
				}
			}

			async function refreshStatus() {
				if (isRefreshing) return;
				isRefreshing = true;

				try {
					const response = await fetch("/api/status");
					const job = await response.json();
					updateStatusUI(job);
				} catch (error) {
					console.error("Failed to refresh status:", error);
					document.getElementById("logContainer").textContent =
						"Failed to load status";
				} finally {
					isRefreshing = false;
				}
			}

			async function stopEncoding() {
				if (
					confirm(
						"Are you sure you want to stop the current encoding job?"
					)
				) {
					try {
						const response = await fetch("/api/stop", {
							method: "POST",
						});
						const result = await response.json();
						if (result.success) {
							alert("Encoding stopped successfully");
							refreshStatus();
						} else {
							alert("Failed to stop encoding: " + result.error);
						}
					} catch (error) {
						alert("Failed to stop encoding: " + error.message);
					}
				}
			}

			function startAutoRefresh() {
				refreshInterval = setInterval(refreshStatus, 2000);
			}

			function stopAutoRefresh() {
				if (refreshInterval) {
					clearInterval(refreshInterval);
					refreshInterval = null;
				}
			}

			// Initialize
			document.addEventListener("DOMContentLoaded", function () {
				refreshStatus();
				loadHardwareInfo();
				startAutoRefresh();
			});

			// Cleanup on page unload
			window.addEventListener("beforeunload", stopAutoRefresh);
		</script>
	</body>
</html>

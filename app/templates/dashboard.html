<!DOCTYPE html>
<html>
	<head>
		<title>Video Encoder Dashboard</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 40px;
			}
			.error {
				color: red;
				background: #fee;
				padding: 10px;
				border: 1px solid red;
				margin: 10px 0;
			}
			.breadcrumb {
				background: #f5f5f5;
				padding: 10px;
				margin: 10px 0;
				border-radius: 4px;
			}
			.breadcrumb-item {
				color: #007cba;
				text-decoration: none;
				margin: 0 5px;
			}
			.breadcrumb-item:hover {
				text-decoration: underline;
			}
			.file-browser {
				border: 1px solid #ddd;
				border-radius: 4px;
				min-height: 400px;
				padding: 15px;
				background: #fafafa;
			}
			.directory-item {
				margin: 8px 0;
				padding: 8px;
				background: #e8f4fd;
				border-radius: 3px;
			}
			.directory-link {
				color: #0066cc;
				text-decoration: none;
				font-weight: bold;
			}
			.directory-link:hover {
				text-decoration: underline;
			}
			.file-item {
				margin: 8px 0;
				padding: 8px;
				background: white;
				border: 1px solid #eee;
				border-radius: 3px;
			}
			.file-item:hover {
				background: #f0f8ff;
			}
			.file-size {
				color: #666;
				font-size: 0.9em;
			}
			.file-date {
				color: #888;
				font-size: 0.8em;
			}
			.empty-directory {
				text-align: center;
				color: #666;
				padding: 40px;
			}
			.loading {
				text-align: center;
				color: #666;
				padding: 20px;
			}
			button {
				background: #007cba;
				color: white;
				padding: 12px 24px;
				border: none;
				cursor: pointer;
				border-radius: 4px;
				font-size: 16px;
				margin: 10px 0;
			}
			button:hover {
				background: #005a87;
			}
			button:disabled {
				background: #ccc;
				cursor: not-allowed;
			}
			.form-container {
				margin: 20px 0;
			}
		</style>
	</head>
	<body>
		<h1>Video Encoder Dashboard</h1>

		<!-- Hardware Status -->
		<div
			style="background: {% if has_nvenc %}#e8f5e8{% else %}#fff3cd{% endif %}; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid {% if has_nvenc %}#d4edda{% else %}#ffeaa7{% endif %};"
		>
			{% if has_nvenc %}
			<strong>üöÄ Hardware Acceleration: ENABLED</strong>
			{% if gpu_info %}
			<br />GPU: {{ gpu_info[0].name }} ({{ gpu_info[0].memory }}MB VRAM)
			{% endif %} <br />Codecs Available: {% if nvenc_caps.av1_nvenc %}AV1
			‚Ä¢{% endif %} {% if nvenc_caps.hevc_nvenc %}HEVC ‚Ä¢{% endif %} {% if
			nvenc_caps.h264_nvenc %}H.264{% endif %} {% else %}
			<strong>‚ö†Ô∏è Hardware Acceleration: DISABLED</strong>
			<br />Using CPU encoding fallback (x265) <br />Consider installing
			NVENC-capable GPU for faster encoding {% endif %}
		</div>

		<form method="post" action="/encode" class="form-container">
			<h2>Browse and Select Video Files</h2>

			<div class="file-browser" id="fileBrowser">
				<div class="loading">Loading files...</div>
			</div>

			<div style="margin: 15px 0">
				<label
					for="codec"
					style="
						display: block;
						margin-bottom: 5px;
						font-weight: bold;
					"
					>Video Codec:</label
				>
				<select
					name="codec"
					id="codec"
					style="padding: 5px; width: 250px; margin-bottom: 10px"
				>
					{% if has_nvenc %} {% if nvenc_caps.av1 %}
					<option value="av1_nvenc" selected>
						AV1 (NVENC) - Best Compression
					</option>
					{% endif %} {% if nvenc_caps.hevc %}
					<option
						value="hevc_nvenc"
						{%
						if
						not
						nvenc_caps.av1
						%}selected{%
						endif
						%}
					>
						HEVC (NVENC) - Good Compression
					</option>
					{% endif %} {% if nvenc_caps.h264 %}
					<option
						value="h264_nvenc"
						{%
						if
						not
						nvenc_caps.av1
						and
						not
						nvenc_caps.hevc
						%}selected{%
						endif
						%}
					>
						H.264 (NVENC) - Fast Encoding
					</option>
					{% endif %} {% endif %}
					<option
						value="x265"
						{%
						if
						not
						has_nvenc
						%}selected{%
						endif
						%}
					>
						HEVC (x265 CPU) - Fallback
					</option>
				</select>

				<label
					for="quality"
					style="
						display: block;
						margin-bottom: 5px;
						font-weight: bold;
					"
					>Quality Level:</label
				>
				<select
					name="quality"
					id="quality"
					style="padding: 5px; width: 250px"
				>
					<option value="high">High Quality (CRF 18)</option>
					<option value="medium" selected>
						Medium Quality (CRF 23)
					</option>
					<option value="low">Low Quality (CRF 28)</option>
				</select>
				<div style="font-size: 12px; color: #666; margin-top: 3px">
					{% if has_nvenc %} {% if nvenc_caps.av1_nvenc %} üöÄ Using
					NVENC AV1 hardware acceleration {% if gpu_info %} ({{
					gpu_info[0].name }}) {% endif %}
					<br />
					High-quality AV1 encoding with excellent compression {% elif
					nvenc_caps.hevc_nvenc %} üöÄ Using NVENC HEVC hardware
					acceleration {% if gpu_info %} ({{ gpu_info[0].name }}) {%
					endif %}
					<br />
					Fast HEVC encoding with good compression {% else %} üöÄ Using
					NVENC H.264 hardware acceleration {% if gpu_info %} ({{
					gpu_info[0].name }}) {% endif %}
					<br />
					Fast H.264 encoding with GPU acceleration {% endif %} {%
					else %} ‚ö†Ô∏è Using CPU x265 encoding (no NVENC detected)<br />
					Slower than GPU acceleration but universally compatible {%
					endif %}
					<br />
					‚Ä¢ MKV container with EAC3 5.1 audio at 448k<br />
					‚Ä¢ Quality-optimized CRF settings: 1080p: CRF 25 ‚Ä¢ 1440p: CRF
					24 ‚Ä¢ 4K: CRF 23
				</div>
			</div>

			<button type="submit" id="encodeBtn" disabled>
				Start Encoding Selected File
			</button>
		</form>

		<br />
		<a
			href="/logs"
			style="
				background: #28a745;
				color: white;
				padding: 10px 20px;
				text-decoration: none;
				border-radius: 4px;
			"
			>üìä View Job Queue & Logs</a
		>

		<script>
			let selectedFilePath = null;

			// Load directory contents
			async function loadDirectory(path = "") {
				const fileBrowser = document.getElementById("fileBrowser");
				fileBrowser.innerHTML = '<div class="loading">Loading...</div>';

				try {
					const response = await fetch(
						`/browse?path=${encodeURIComponent(path)}`
					);
					const html = await response.text();
					fileBrowser.innerHTML = html;

					// Re-attach event listeners for radio buttons
					attachFileSelectionListeners();
				} catch (error) {
					fileBrowser.innerHTML = `<div class="error">Error loading directory: ${error.message}</div>`;
				}
			}

			// Attach event listeners to radio buttons
			function attachFileSelectionListeners() {
				const radioButtons = document.querySelectorAll(
					'input[name="file_path"]'
				);
				radioButtons.forEach((radio) => {
					radio.addEventListener("change", function () {
						selectedFilePath = this.value;
						document.getElementById("encodeBtn").disabled = false;
					});
				});
			}

			// Handle form submission
			document
				.querySelector("form")
				.addEventListener("submit", async function (e) {
					e.preventDefault(); // Always prevent default submission

					if (!selectedFilePath) {
						alert("Please select a video file to encode.");
						return;
					}

					const submitBtn = document.getElementById("encodeBtn");
					const originalText = submitBtn.textContent;

					try {
						// Disable button and show loading
						submitBtn.disabled = true;
						submitBtn.textContent = "Adding to Queue...";

						// Get form data
						const formData = new FormData(this);
						formData.append("file_path", selectedFilePath);

						// Submit via AJAX
						const response = await fetch("/encode", {
							method: "POST",
							body: formData,
						});

						const result = await response.json();

						if (result.success) {
							// Show success message
							alert(
								`‚úÖ Encoding job started!\n\nFile: ${result.filename}\nPreset: ${result.preset}\n\nRedirecting to status page to monitor progress.`
							);

							// Redirect to logs page
							setTimeout(() => {
								window.location.href = "/logs";
							}, 1500);
						} else {
							// Show error message
							alert(
								`‚ùå Failed to start encoding job:\n${result.error}`
							);
						}
					} catch (error) {
						console.error("Error submitting job:", error);
						alert("‚ùå Network error occurred. Please try again.");
					} finally {
						// Re-enable button
						submitBtn.disabled = false;
						submitBtn.textContent = originalText;
					}
				});

			// Load root directory on page load
			document.addEventListener("DOMContentLoaded", function () {
				loadDirectory("{{ current_path }}");
			});
		</script>
	</body>
</html>
